(function(){var a,b={};typeof module!="undefined"&&module.exports?a=exports:a=window.RMIJS=window.RMIJS||{},b.RMI=0,b.RMI_REPLY=1,b.RMI_PUSH=2,b.RMI_ERROR=3,b.RMI_ERROR_NOT_IMPLEMENTED_MSG="Method Not Implemented",b.MessageHelper={},b.MessageHelper.o2m=function(a){var c=[];switch(a.type){case b.RMI:c[0]=b.RMI,c[1]=a.invocationId,c[2]=a.remoteMethod,c[3]=a.remoteMethodArgs;break;case b.RMI_REPLY:case b.RMI_ERROR:c[0]=a.type,c[1]=a.invocationId,c[2]=a.result;break;case b.RMI_PUSH:c[0]=b.RMI_PUSH,c[1]=a.fn,c[2]=a.fnName}return c},b.MessageHelper.m2o=function(a){var c={};switch(a[0]){case b.RMI:c.type=b.RMI,c.invocationId=a[1],c.remoteMethod=a[2],c.remoteMethodArgs=a[3];break;case b.RMI_REPLY:case b.RMI_ERROR:c.type=a[0],c.invocationId=a[1],c.result=a[2];break;case b.RMI_PUSH:c.type=a[0],c.fn=a[1],c.fnName=a[2]}return c},a.Messages=b})(),function(){var a,b;typeof module!="undefined"&&module.exports?a=exports:a=window.RMIJS=window.RMIJS||{},b=a.Utilities={},b.StopWatch=function(){if(!(this instanceof b.StopWatch))return new b.StopWatch;this.start=0,this.stop=0},b.StopWatch.prototype.start=function(){this.start=(new Date).getTime()},b.StopWatch.prototype.stop=function(){this.stop=(new Date).getTime()},b.StopWatch.prototype.reset=function(){this.start=0,this.stop=0},b.StopWatch.prototype.getTimeInMilliseconds=function(){return this.stop-this.start},b.StopWatch.prototype.getTimeInSeconds=function(){return this.getTimeInMilliseconds()/1e3},b.LOG=function(){},b.random=function(a){var b,c,d,e,f=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","1","2","3","4","5","6","7","8","9","0"];e=a?a:12,b="";for(c=0;c<e;c++)d=Math.floor(Math.random()*f.length),b+=f[d];return b}}(),function(window){var R=window.RMIJS=window.RMIJS||{},LOG=R.Utilities.LOG||function(){console.log(arguments)},C={},that,_cProto,_pProto,_isFn,_getClosure,_getRandomId,_throw,_webSocket,_onReturnValueReceived,_onPushReceived,_onEndpointConnected,_stopWatch,_messageHelper;C.RMI=R.Messages.RMI,C.RMI_REPLY=R.Messages.RMI_REPLY,C.RMI_PUSH=R.Messages.RMI_PUSH,C.RMI_ERROR=R.Messages.RMI_ERROR,C.RMI_EP_CONNECTED=R.Messages.RMI_EP_CONNECTED,C.FAIL_SILENTLY=!0,_isFn=function(a){return typeof a=="function"},_getRandomId=R.Utilities.random,_messageHelper=R.Messages.MessageHelper,_getClosure=function(a){return function(){var b=Array.prototype.splice.call(arguments,0);return b.unshift(a),_cProto._invokeRemote.apply(that,b)}},_throw=function(a){if(!that.failSilently)throw new Error(a)},_onReturnValueReceived=function(a){a=_messageHelper.m2o(a),LOG(a),that._receiveAndNotifyListener(a)},_onEndpointConnected=function(){_webSocket._epConnected=!0},_onPushReceived=function(data){data=_messageHelper.m2o(data),LOG("Function "+data.fnName+" pushed from endpoint.");var f;eval("f="+data.fn),_isFn(f)&&that._pushToLocal(data.fnName,f)},_stopWatch=R.Utilities.StopWatch(),R.Promise=function(a){this.id=a,this.result=null,this.error=null,this.thenSuccess=null,this.thenError=null},_pProto=R.Promise.prototype,_pProto.then=function(a,b){var c=_isFn(a),d=_isFn(b);c&&(this.thenSuccess=a),d&&(this.thenError=b)},_pProto.resolve=function(a){var b=this;b.result=a,_isFn(b.thenSuccess)&&b.thenSuccess.apply(b,[a,b])},_pProto.reject=function(a){var b=this;b.error=a,_isFn(b.thenError)&&b.thenError.apply(b,[a,b])},R.Client=function(a){if(!(this instanceof R.Client))return new R.Client(a);that=this,that.callbackRegistry={},that.promiseRegistry={},that.endpoint=null,that.initWithStub(a),that.failSilently=C.FAIL_SILENTLY,that.localStub=a},_cProto=R.Client.prototype,_cProto.setEndpoint=function(a,b){that.endpoint=a,(b||b===undefined)&&that._connect()},_cProto.initWithStub=function(a){var b,c;for(b in a)a.hasOwnProperty(b)&&(c=a[b],_isFn(c)&&c.remote===!0&&(a[b]=_getClosure(b)))},_cProto._connect=function(){that.endpoint?(_webSocket=io.connect(that.endpoint),_webSocket.on(C.RMI_REPLY,_onReturnValueReceived),_webSocket.on(C.RMI_PUSH,_onPushReceived)):_throw("Can't connect without endpoint. Hint: use setEndpoint first.")},_cProto._invokeRemote=function(){var a=Array.prototype.slice.call(arguments,0),b,c,d,e,f,g;return b=a.shift(),d=a.pop(),c=a,e=_getRandomId(),_isFn(d)?that._registerCallback(e,d):(c.unshift(d),d=null),g=new R.Promise(e),that._registerPromise(e,g),f=that._serialize(b,c,e),LOG("Invoking, ",f),that._doInvokeRemote(f),g},_cProto._registerCallback=function(a,b){that.callbackRegistry[a]=b},_cProto._registerPromise=function(a,b){that.promiseRegistry[a]=b},_cProto._receiveAndNotifyListener=function(a){var b=a.invocationId,c=that.callbackRegistry[b],d=that.promiseRegistry[b];d instanceof R.Promise&&(a.type===C.RMI_ERROR?d.reject(a.result):d.resolve(a.result),d=null),_isFn(c)&&a.type!==C.RMI_ERROR&&c(a.result),delete that.callbackRegistry[b]},_cProto._doInvokeRemote=function(a){_webSocket?_webSocket.emit(a.type,data=_messageHelper.o2m(a)):_throw("Endpoint connection was not set or failed.")},_cProto._serialize=function(a,b,c){var d={type:C.RMI,remoteMethod:a,remoteMethodArgs:b,invocationId:c};return d},_cProto._pushToLocal=function(a,b){that.localStub[a]=b},R.version="0.1.0"}(this)